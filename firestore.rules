rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user role from profile
    function getUserRole() {
      return get(/databases/$(database)/documents/artifacts/$(request.auth.token.app_id)/users/$(request.auth.uid)/user_metadata/profile).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Helper function to check if user is teacher or admin
    function isTeacherOrAdmin() {
      return isAuthenticated() && (getUserRole() == 'teacher' || getUserRole() == 'admin');
    }

    // Helper function to check if user is marker or admin
    function isMarkerOrAdmin() {
      return isAuthenticated() && (getUserRole() == 'marker' || getUserRole() == 'admin');
    }

    // User profiles: users can read/write their own; admins can read/write all
    match /artifacts/{appId}/users/{userId}/user_metadata/profile {
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Exams: authenticated users can read; teachers and admins can write
    match /artifacts/{appId}/exams/{examId} {
      allow read: if isAuthenticated();
      allow write: if isTeacherOrAdmin();
    }

    // Allow read/write for other collections if needed, but restrict by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
